openapi: 3.0.3
info:
  title: Browser Automation Service API
  description: |
    REST API for Browser Automation Service providing:
    - Browser automation control via MCP tools
    - Knowledge retrieval and website exploration
    - Real-time event streaming via WebSocket
    - Session management and monitoring
    
    **Communication Architecture:**
    - Commands (Agent → Browser): Use BullMQ for reliable, persistent command processing
    - Events (Browser → Agent): Use Redis Pub/Sub for high-frequency, real-time events
    - Video Streaming: LiveKit WebRTC for real-time video
  version: 1.0.0
  contact:
    name: Browser Automation Service
    url: https://github.com/browser-use/browser-use

servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://api.example.com
    description: Production server (example)

tags:
  - name: Browser Automation
    description: Browser automation control via MCP tools
  - name: Knowledge Retrieval
    description: Website exploration and knowledge extraction
  - name: Health & Monitoring
    description: Health checks and connection monitoring
  - name: WebSocket
    description: Real-time event streaming

paths:
  /health:
    get:
      tags:
        - Health & Monitoring
      summary: Health check
      description: Check if the service is running and healthy
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '500':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /rooms/{room_name}/connections:
    get:
      tags:
        - Health & Monitoring
      summary: Get WebSocket connection count
      description: Get the number of active WebSocket connections for a room
      operationId: getConnections
      parameters:
        - name: room_name
          in: path
          required: true
          description: LiveKit room name
          schema:
            type: string
            example: demo-room
      responses:
        '200':
          description: Connection count retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectionCountResponse'
        '404':
          description: Room not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /mcp/tools:
    get:
      tags:
        - Browser Automation
      summary: List MCP tools
      description: Get a list of all available MCP tools
      operationId: listMCPTools
      responses:
        '200':
          description: List of available tools
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MCPToolsResponse'

  /mcp/tools/call:
    post:
      tags:
        - Browser Automation
      summary: Execute MCP tool
      description: Execute an MCP tool via HTTP
      operationId: callMCPTool
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MCPToolCallRequest'
            examples:
              startBrowserSession:
                summary: Start browser session
                value:
                  tool: start_browser_session
                  arguments:
                    room_name: demo-room
                    initial_url: https://www.google.com
                    viewport_width: 1920
                    viewport_height: 1080
                    fps: 10
              executeAction:
                summary: Execute click action
                value:
                  tool: execute_action
                  arguments:
                    room_name: demo-room
                    action_type: click
                    params:
                      index: 0
      responses:
        '200':
          description: Tool executed successfully
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/BrowserSessionResponse'
                  - $ref: '#/components/schemas/ActionResult'
                  - $ref: '#/components/schemas/BrowserContext'
                  - $ref: '#/components/schemas/ScreenContent'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Tool not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/knowledge/explore/start:
    post:
      tags:
        - Knowledge Retrieval
      summary: Start knowledge retrieval job
      description: Start a new knowledge retrieval job to explore and extract knowledge from a website
      operationId: startExploration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StartExplorationRequest'
            examples:
              basic:
                summary: Basic exploration
                value:
                  start_url: https://example.com
                  max_pages: 50
                  max_depth: 3
                  strategy: BFS
              advanced:
                summary: Advanced exploration with custom job ID
                value:
                  start_url: https://example.com
                  max_pages: 100
                  max_depth: 5
                  strategy: DFS
                  job_id: custom-job-123
      responses:
        '200':
          description: Job started successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StartExplorationResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/knowledge/explore/status/{job_id}:
    get:
      tags:
        - Knowledge Retrieval
      summary: Get job status
      description: Get live progress and status for a knowledge retrieval job
      operationId: getJobStatus
      parameters:
        - name: job_id
          in: path
          required: true
          description: Job ID
          schema:
            type: string
            example: 01ARZ3NDEKTSV4RRFFQ69G5FAV
      responses:
        '200':
          description: Job status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobStatusResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/knowledge/explore/pause:
    post:
      tags:
        - Knowledge Retrieval
      summary: Pause job
      description: Pause a running knowledge retrieval job
      operationId: pauseJob
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobControlRequest'
      responses:
        '200':
          description: Job paused successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobControlResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '400':
          description: Job cannot be paused (not running)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/knowledge/explore/resume:
    post:
      tags:
        - Knowledge Retrieval
      summary: Resume job
      description: Resume a paused knowledge retrieval job
      operationId: resumeJob
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobControlRequest'
      responses:
        '200':
          description: Job resumed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobControlResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '400':
          description: Job cannot be resumed (not paused)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/knowledge/explore/cancel:
    post:
      tags:
        - Knowledge Retrieval
      summary: Cancel job
      description: Cancel a knowledge retrieval job. Job cannot be resumed after cancellation.
      operationId: cancelJob
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobControlRequest'
      responses:
        '200':
          description: Job cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobControlResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/knowledge/explore/results/{job_id}:
    get:
      tags:
        - Knowledge Retrieval
      summary: Get job results
      description: Get results for a knowledge retrieval job (partial or final)
      operationId: getJobResults
      parameters:
        - name: job_id
          in: path
          required: true
          description: Job ID
          schema:
            type: string
            example: 01ARZ3NDEKTSV4RRFFQ69G5FAV
        - name: partial
          in: query
          required: false
          description: If true, return partial results even if job is still running
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Results retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResultsResponse'
        '400':
          description: Job is still running and partial=false
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/knowledge/explore/jobs:
    get:
      tags:
        - Knowledge Retrieval
      summary: List all jobs
      description: Get a summary of all knowledge retrieval jobs
      operationId: listJobs
      responses:
        '200':
          description: List of jobs retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobsListResponse'

  /api/knowledge/explore/ws/{job_id}:
    get:
      tags:
        - Knowledge Retrieval
        - WebSocket
      summary: WebSocket endpoint for real-time progress updates
      description: |
        WebSocket endpoint for real-time knowledge retrieval progress updates.
        Connect to this endpoint to receive live progress events without polling.
        
        **Connection**: `ws://localhost:8000/api/knowledge/explore/ws/{job_id}`
        
        **Message Types**:
        - `connected`: Connection established
        - `progress`: Progress update with enhanced metrics (estimated_time_remaining, processing_rate, recent_pages)
        - `page_completed`: Page processing completed
        - `external_link_detected`: External link detected
        - `error`: Error occurred
      operationId: knowledgeExplorationWebSocket
      parameters:
        - name: job_id
          in: path
          required: true
          description: Job ID
          schema:
            type: string
            example: 01ARZ3NDEKTSV4RRFFQ69G5FAV
      responses:
        '101':
          description: WebSocket connection established
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/knowledge/explore/ws/{job_id}:
    get:
      tags:
        - Knowledge Retrieval
        - WebSocket
      summary: WebSocket endpoint for real-time progress updates
      description: |
        WebSocket endpoint for real-time knowledge retrieval progress updates.
        Connect to this endpoint to receive live progress events without polling.
        
        **Connection**: `ws://localhost:8000/api/knowledge/explore/ws/{job_id}`
        
        **Message Types**:
        - `connected`: Connection established
        - `progress`: Progress update with enhanced metrics
        - `page_completed`: Page processing completed
        - `external_link_detected`: External link detected
        - `error`: Error occurred
      operationId: knowledgeExplorationWebSocket
      parameters:
        - name: job_id
          in: path
          required: true
          description: Job ID
          schema:
            type: string
            example: 01ARZ3NDEKTSV4RRFFQ69G5FAV
      responses:
        '101':
          description: WebSocket connection established
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
        service:
          type: string
          example: browser-automation-websocket
      required:
        - status
        - service

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error message
          example: Job not found
        detail:
          type: string
          description: Detailed error information
          example: Job with ID 01ARZ3NDEKTSV4RRFFQ69G5FAV does not exist

    ConnectionCountResponse:
      type: object
      properties:
        room_name:
          type: string
          example: demo-room
        connection_count:
          type: integer
          description: Number of active WebSocket connections
          example: 2
      required:
        - room_name
        - connection_count

    MCPToolsResponse:
      type: object
      properties:
        tools:
          type: array
          items:
            $ref: '#/components/schemas/MCPTool'
      required:
        - tools

    MCPTool:
      type: object
      properties:
        name:
          type: string
          example: start_browser_session
        description:
          type: string
          example: Start a browser session for a LiveKit room with video streaming
      required:
        - name
        - description

    MCPToolCallRequest:
      type: object
      properties:
        tool:
          type: string
          description: Name of the MCP tool to execute
          enum:
            - start_browser_session
            - pause_browser_session
            - resume_browser_session
            - close_browser_session
            - execute_action
            - get_browser_context
            - get_screen_content
            - recover_browser_session
            - start_knowledge_exploration
            - get_exploration_status
            - pause_exploration
            - resume_exploration
            - cancel_exploration
            - get_knowledge_results
            - query_knowledge
          example: start_browser_session
        arguments:
          type: object
          description: Tool-specific arguments
          additionalProperties: true
      required:
        - tool
        - arguments

    BrowserSessionResponse:
      type: object
      properties:
        status:
          type: string
          enum:
            - started
            - paused
            - resumed
            - closed
            - recovered
          example: started
        room_name:
          type: string
          example: demo-room
      required:
        - status
        - room_name

    ActionResult:
      type: object
      properties:
        success:
          type: boolean
          example: true
        error:
          type: string
          nullable: true
          example: null
        data:
          type: object
          additionalProperties: true
      required:
        - success

    BrowserContext:
      type: object
      properties:
        url:
          type: string
          format: uri
          example: https://www.google.com
        title:
          type: string
          example: Google
        ready_state:
          type: string
          enum:
            - loading
            - interactive
            - complete
          example: complete
        scroll_x:
          type: integer
          example: 0
        scroll_y:
          type: integer
          example: 0
        viewport_width:
          type: integer
          example: 1920
        viewport_height:
          type: integer
          example: 1080
        cursor_x:
          type: integer
          example: 100
        cursor_y:
          type: integer
          example: 200
      required:
        - url
        - title
        - ready_state
        - scroll_x
        - scroll_y
        - viewport_width
        - viewport_height
        - cursor_x
        - cursor_y

    ScreenContent:
      type: object
      properties:
        url:
          type: string
          format: uri
          example: https://www.google.com
        title:
          type: string
          example: Google
        dom_summary:
          type: string
          description: Summary of DOM structure for agent communication
          example: Page contains search form with input field and submit button
        visible_elements_count:
          type: integer
          example: 15
        scroll_x:
          type: integer
          example: 0
        scroll_y:
          type: integer
          example: 0
        viewport_width:
          type: integer
          example: 1920
        viewport_height:
          type: integer
          example: 1080
        cursor_x:
          type: integer
          example: 100
        cursor_y:
          type: integer
          example: 200
      required:
        - url
        - title
        - dom_summary
        - visible_elements_count
        - scroll_x
        - scroll_y
        - viewport_width
        - viewport_height
        - cursor_x
        - cursor_y

    StartExplorationRequest:
      type: object
      properties:
        start_url:
          type: string
          format: uri
          description: Starting URL for exploration
          example: https://example.com
        max_pages:
          type: integer
          nullable: true
          description: Maximum number of pages to explore (optional)
          minimum: 1
          example: 100
        max_depth:
          type: integer
          description: Maximum exploration depth
          default: 3
          minimum: 1
          maximum: 10
          example: 3
        strategy:
          type: string
          enum:
            - BFS
            - DFS
          description: Exploration strategy - BFS (breadth-first) or DFS (depth-first)
          default: BFS
          example: BFS
        job_id:
          type: string
          nullable: true
          description: Optional job ID (auto-generated if not provided)
          example: 01ARZ3NDEKTSV4RRFFQ69G5FAV
        include_paths:
          type: array
          items:
            type: string
          nullable: true
          description: Path patterns to include (e.g., ['/docs/*', '/api/v1/*'])
          example: ['/docs/*']
        exclude_paths:
          type: array
          items:
            type: string
          nullable: true
          description: Path patterns to exclude (e.g., ['/admin/*', '/api/*'])
          example: ['/admin/*', '/api/*']
      required:
        - start_url

    StartExplorationResponse:
      type: object
      properties:
        job_id:
          type: string
          description: Job ID for tracking
          example: 01ARZ3NDEKTSV4RRFFQ69G5FAV
        status:
          type: string
          enum:
            - queued
            - running
          example: queued
        message:
          type: string
          example: Job queued via BullMQ. Use /api/knowledge/explore/status/{job_id} to check progress.
      required:
        - job_id
        - status

    JobStatusResponse:
      type: object
      properties:
        job_id:
          type: string
          example: 01ARZ3NDEKTSV4RRFFQ69G5FAV
        status:
          type: string
          enum:
            - idle
            - queued
            - running
            - paused
            - completed
            - failed
            - cancelled
            - cancelling
          example: running
        paused:
          type: boolean
          example: false
        current_page:
          type: string
          format: uri
          nullable: true
          example: https://example.com/page
        pages_completed:
          type: integer
          example: 5
        pages_queued:
          type: integer
          example: 10
        pages_failed:
          type: integer
          example: 0
        links_discovered:
          type: integer
          example: 50
        external_links_detected:
          type: integer
          example: 5
        error:
          type: string
          nullable: true
          example: null
        estimated_time_remaining:
          type: number
          format: float
          nullable: true
          description: Estimated time remaining in seconds
          example: 120.5
        processing_rate:
          type: number
          format: float
          nullable: true
          description: Processing rate in pages per minute
          example: 2.5
        recent_pages:
          type: array
          items:
            type: object
            properties:
              url:
                type: string
                format: uri
              title:
                type: string
              completed_at:
                type: number
                format: float
          nullable: true
          description: List of recently completed pages with titles
      required:
        - job_id
        - status
        - paused

    ProgressMetrics:
      type: object
      properties:
        completed:
          type: integer
          description: Number of pages completed
          example: 5
        queued:
          type: integer
          description: Number of pages queued for exploration
          example: 10
        failed:
          type: integer
          description: Number of pages that failed
          example: 0
        current_url:
          type: string
          format: uri
          nullable: true
          description: URL currently being processed
          example: https://example.com/page
      required:
        - completed
        - queued
        - failed

    JobControlRequest:
      type: object
      properties:
        job_id:
          type: string
          description: Job ID
          example: 01ARZ3NDEKTSV4RRFFQ69G5FAV
        wait_for_current_page:
          type: boolean
          description: For cancel: wait for current page to complete before cancelling
          default: false
          example: false
      required:
        - job_id

    JobControlResponse:
      type: object
      properties:
        job_id:
          type: string
          example: 01ARZ3NDEKTSV4RRFFQ69G5FAV
        status:
          type: string
          enum:
            - paused
            - resumed
            - cancelled
          example: paused
      required:
        - job_id
        - status

    JobResultsResponse:
      type: object
      properties:
        job_id:
          type: string
          example: 01ARZ3NDEKTSV4RRFFQ69G5FAV
        status:
          type: string
          enum:
            - running
            - completed
            - failed
            - cancelled
          example: completed
        results:
          $ref: '#/components/schemas/ExplorationResults'
        pages:
          type: array
          items:
            $ref: '#/components/schemas/PageData'
          description: List of explored pages (only if status is completed or partial=true)
        links:
          type: array
          items:
            $ref: '#/components/schemas/LinkData'
          description: List of discovered links (only if status is completed or partial=true)
      required:
        - job_id
        - status
        - results

    ExplorationResults:
      type: object
      properties:
        pages_stored:
          type: integer
          description: Number of pages stored
          example: 50
        links_stored:
          type: integer
          description: Number of links stored
          example: 200
        external_links_detected:
          type: integer
          description: Number of external links detected (not followed)
          example: 10
        errors:
          type: array
          items:
            type: object
            properties:
              url:
                type: string
                format: uri
              error:
                type: string
              error_type:
                type: string
                enum:
                  - network
                  - timeout
                  - http_4xx
                  - http_5xx
                  - parsing
                  - other
                description: Error category for better error handling
          description: List of errors encountered during exploration
        website_metadata:
          type: object
          description: Website metadata extracted from start page
          properties:
            title:
              type: string
              example: Example Domain
            description:
              type: string
              nullable: true
              example: This is an example domain
            url:
              type: string
              format: uri
              example: https://example.com
      required:
        - pages_stored
        - links_stored
        - external_links_detected
        - errors

    PageData:
      type: object
      properties:
        url:
          type: string
          format: uri
          example: https://example.com
        title:
          type: string
          example: Example Domain
        content:
          type: string
          description: Extracted page content
          example: This domain is for use in illustrative examples...
        metadata:
          type: object
          additionalProperties: true
          description: Additional page metadata
      required:
        - url
        - title

    LinkData:
      type: object
      properties:
        from:
          type: string
          format: uri
          example: https://example.com
        to:
          type: string
          format: uri
          example: https://example.com/page1
        type:
          type: string
          enum:
            - internal
            - external
          description: Link type - internal (same domain) or external (different domain)
          example: internal
        text:
          type: string
          nullable: true
          description: Link text
          example: Click here
      required:
        - from
        - to
        - type

    JobsListResponse:
      type: object
      properties:
        jobs:
          type: array
          items:
            $ref: '#/components/schemas/JobSummary'
      required:
        - jobs

    JobSummary:
      type: object
      properties:
        job_id:
          type: string
          example: 01ARZ3NDEKTSV4RRFFQ69G5FAV
        status:
          type: string
          enum:
            - idle
            - queued
            - running
            - paused
            - completed
            - failed
            - cancelled
          example: running
        start_url:
          type: string
          format: uri
          example: https://example.com
        started_at:
          type: string
          format: date-time
          nullable: true
          example: '2025-01-12T10:00:00Z'
      required:
        - job_id
        - status
        - start_url
